import pandas as pd
from shapely.geometry import Point
import geopandas as gp
from src.geom_helper import pts2seg

lonlats =[(-77.0499797097, 38.9025337467), (-76.9750248217, 38.9342833419), (-77.0499797097, 38.9025337467), (-77.018353403, 38.8174155704),
 (-77.0499797097, 38.9025337467), (-77.0499797097, 38.9025337467), (-77.0499797097, 38.9025337467), (-77.0499797097, 38.9025337467),
 (-76.982369647, 38.9416450899), (-77.01466812, 38.9264066913), (-77.01466812, 38.9264066913), (-77.0731913537, 38.9241655819),
 (-77.0060749316, 38.9344875478), (-77.0172487613, 38.8206668992), (-77.1099421133, 38.9334457127), (-77.0248761622, 38.9299447811),
 (-77.091346861, 38.9414896542), (-76.9651641877, 38.9251762117), (-76.9651641877, 38.9251762117), (-76.9651641877, 38.9251762117),
 (-77.0085563587, 38.8724597385), (-77.0085563587, 38.8724597385), (-77.0499797097, 38.9025337467), (-77.1099421133, 38.9334457127),
 (-77.1099421133, 38.9334457127), (-76.9663809737, 38.9176546129), (-77.0142406682, 38.8920467534), (-77.0142406682, 38.8920467534),
 (-77.0004259836, 38.9641158389), (-76.9810398283, 38.9041776464), (-76.9926023075, 38.9380717842), (-77.0499797097, 38.9025337467),
 (-77.0499797097, 38.9025337467), (-76.9590017698, 38.8619306698), (-77.0367570316, 38.9834042588), (-77.018353403, 38.8174155704),
 (-77.018353403, 38.8174155704), (-77.018353403, 38.8174155704), (-76.9584917822, 38.9200200968), (-76.9833049061, 38.8533051238),
 (-76.9833049061, 38.8533051238), (-77.01466812, 38.9264066913), (-76.9584917822, 38.9200200968), (-77.0499797097, 38.9025337467),
 (-77.0085563587, 38.8724597385), (-77.0085563587, 38.8724597385), (-77.0060749316, 38.9344875478), (-77.0060749316, 38.9344875478),
]

pts = [Point(lonlat) for lonlat in lonlats]
pts_gpdf = gp.GeoDataFrame(pts, columns=['geometry'])


segs_path = 'data/opendc_segments.geojson'
segs = gp.read_file(segs_path)

pts_has_seg, pts_no_seg = pts2seg(pts_gpdf, segs, bfr_crs=3559)
print 'total pts=', len(pts)
print 'pts has seg=', pd.unique(pts_has_seg.pt_index).shape[0]
print 'pts has no seg=', pts_no_seg.shape[0]
for x in pts_no_seg.geometry.apply(lambda x: 'https://www.google.com/maps/place/{}%20{}'.format(x.coords[0][1], x.coords[0][0])).tolist():
    print x

pts_segids = pts_has_seg.merge(segs[['STREETSEGID']], left_on=['seg_index'], right_index=True)
print pts_segids.sort('pt_index')