
<!DOCTYPE html>
<html>
<head>
    <title>DC pred map with probexperience</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
    <link rel="stylesheet" href="css/leaflet.groupedlayercontrol.min.css" />
    
    <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.13.0/d3.min.js"></script>
    <script src="js/leaflet.groupedlayercontrol.min.js"></script>
    <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>
    <script src="js/echarts.common.min.js"></script>
    <style>
    html, body {
        height:100%;
        width:100%;
        margin:0;
        padding:0;
    }
    #map {
        width: 100%;
        height: 100%;
    }
    .column-2 {
        float: left;
        width: 20%;
    }
    .column-8 {
        float: left;
        width: 80%;
        height: 100%
    }
    /* Clear floats after the columns */
    .row:after {
        content: "";
        display: table;
        clear: both;
    }
    
        .legend {
            background: white;
            line-height: 30px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 10px;
            float: left;
            margin-right: 8px;
        }
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            
        }

    </style>
</head>
<body>

<div class="row" style="height:100%; margin-left:10px">
  <div class="column-2">
     <p>It might take a while to load the predicted cycling safety level visualization. Once the map is loaded, you can click on each segment to see the prediction probability.</p>
    <ul style="padding-right:20px">
        <li>Model:  XGBoost</li>
        <li>Ground Truth: ratings that collected until 2017-10-01</li>
        <li>Weight Scheme: Experience</li>
        <li>Features: Built-in + Social type + spatial autocorrelated features</li>
    </ul>
  </div>
  <div class="column-8"><div id='map'></div></div>
</div>

<!-- geojson data file-->
<script src="DC pred map with probexperience.js" type="text/javascript"></script>

<script>
    function set_style(feature){return {color: feature.properties.color};}
    function set_prob_color(feature){return {color: feature.properties.proba_color};}
    function set_true_color(feature){return {color: feature.properties.ground_truth_color};}
    
    function onEachFeature(feature,layer){
        var popUpContent = '';
        for (var key in feature.properties) {
            val = feature.properties[key];
            popUpContent += key + ':' + val + "<br>";
        }
        layer.bindPopup(popUpContent);
    }
    var legendData = ['Very dangerous', 'Dangerous', 'Normal', 'Safe', 'Very safe'];
    var colorData = ['#d7191c' ,'#fdae61','#ffffbf','#a6d96a','#1a9641'];

    function groundTruthPopup(feature, layer){
        var label = legendData[feature.properties['Ground Truth Level']-1];
        layer.bindPopup('Ground Truth Level is: '+ label);
    }
    
    function pieChartPopup(feature, layer){
        layer.on('click', function (e) {
            //console.log('click on layer');
            //destroy any old popups that might be attached
            if (layer._popup != undefined) {
                layer.unbindPopup();
            }
            var id_name = 'popup_'+feature.properties.index_seg;
            var div = $('<div id="'+id_name+'" class="popupGraph" style="width: 330px; height:200px;">hihi</div>')[0];
            var popup = L.popup().setContent(div);
            layer.bindPopup(popup, {maxWidth : 560}).openPopup();
            
            var myChart = echarts.init(div);
            
            var seriesData = [{name:'Very dangerous', value:feature.properties['very dangerous']}, {name:'Dangerous', value:feature.properties['dangerous']}, {name:'Normal', value:feature.properties['normal']}, {name:'Safe', value:feature.properties['safe']}, {name:'Very safe', value:feature.properties['very safe']}];
            option = {
                color: colorData,
                title:{text: 'Predicted Safety Level Probability',textStyle:{fontSize:13},x:'center', },
                tooltip : {trigger: 'item',formatter: "{b} : {d}%"},
                legend: {left: 0,top:20,orient: 'vertical',data: legendData,},
                series : [{type: 'pie', data: seriesData, radius: ['50%', '70%'],avoidLabelOverlap: false,label: {normal: {show: false,position: 'center'},emphasis: {show: true,textStyle: {fontSize: '12',color: 'black',}}},}]
            };
            
            if (option && typeof option === "object") {
                myChart.setOption(option, true);
            }
        });
    }

    var dark_black = L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',});
    
var osm_mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'});
     

    
    var pred_map_layer = new L.LayerGroup();
    L.geoJSON(pred_map, {style: set_style,onEachFeature: pieChartPopup}).addTo(pred_map_layer);
    
    var pred_map_proba_color_layer = new L.LayerGroup();
    L.geoJSON(pred_map, {style: set_prob_color,onEachFeature: pieChartPopup}).addTo(pred_map_proba_color_layer);
    
    
    var true_map_layer = new L.LayerGroup();
    L.geoJSON(true_map, {style: set_style,onEachFeature: groundTruthPopup}).addTo(true_map_layer);
    

    
    var baseLayers = {
        'CartoDB Dark Style': dark_black, 'OpenStreetMap Style': osm_mapnik, 
    };
            
    
    var map_layers = {
        'ground truth map colored by safety level': true_map_layer, 
        'predicted map colored by safety level': pred_map_layer, 
        'predicted map colored by prediction probability': pred_map_proba_color_layer, 
    };
            
    
    var groupedOverlays = {
      "maps": map_layers
    };
    var options = {
      // Make the "Landmarks" group exclusive (use radio inputs)
      exclusiveGroups: ["maps"],
    };

    var map = L.map('map', {
        center: [38.925857, -77.031259],
        zoom: 13,
        layers: [dark_black, true_map_layer]
    });
    
    L.control.groupedLayers(baseLayers, groupedOverlays, options).addTo(map);
    //L.control.layers(radio_layers, check_layers).addTo(map);
    
    
    function getColor(d) {
        return d > 4.5 ? '#1a9641' :
               d > 3.5  ? '#a6d96a' :
               d > 2.5  ? '#ffffbf' :
               d > 1.5  ? '#fdae61' :
                          '#d7191c';
    }
    // legend on bottom right
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend');
        var grades = [1, 1.5, 2.5, 3.5, 4.5];
        var labels = ['Very dangerous', 'Dangerous', 'Normal', 'Safe', ' Very safe'];
        // loop through our density intervals and generate a label with a colored square for each interval
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 0.1, 1) + '"></i> ' + '<label>' +labels[i] + '</label>'+ '<br>';
        }
        return div;
    };
    legend.addTo(map);
    
</script>
</body>
</html>
