<?xml version="1.0"?>
<mysqldump xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<database name="cyclings_test">
	<table_data name="Rating">
	<row>
		<field name="rid">1</field>
		<field name="uid">1</field>
		<field name="email"></field>
		<field name="vid">1</field>
		<field name="score">5</field>
		<field name="comment"></field>
		<field name="tags"></field>
		<field name="familiar"></field>
	</row>
	<row>
		<field name="rid">2</field>
		<field name="uid">1</field>
		<field name="email"></field>
		<field name="vid">2</field>
		<field name="score">4</field>
		<field name="comment"></field>
		<field name="tags"></field>
		<field name="familiar"></field>
	</row>
	</table_data>
	<triggers name="Rating">
		<trigger Trigger="inc_SegScore" sql_mode="NO_ENGINE_SUBSTITUTION" character_set_client="utf8" collation_connection="utf8_general_ci" Database_Collation="utf8_unicode_ci">
<![CDATA[
CREATE DEFINER=`cyclingsafetyumd`@`localhost` TRIGGER `inc_SegScore` AFTER INSERT ON `Rating`
 FOR EACH ROW BEGIN
  UPDATE 
    RoadSegment s,
    VideoRoadSeg vs
  SET 
    sumCnt = sumCnt + 1, 
    sumRatio = sumRatio + vs.ratio,
    sumScore = sumScore + NEW.score * vs.ratio
  where s.sid=vs.sid and vs.vid=NEW.vid;

END
]]>
		</trigger>
		<trigger Trigger="dec_SegScore" sql_mode="NO_ENGINE_SUBSTITUTION" character_set_client="utf8" collation_connection="utf8_general_ci" Database_Collation="utf8_unicode_ci">
<![CDATA[
CREATE DEFINER=`cyclingsafetyumd`@`localhost` TRIGGER `dec_SegScore` AFTER DELETE ON `Rating`
 FOR EACH ROW BEGIN
  UPDATE 
    RoadSegment s,
    VideoRoadSeg vs
  SET 
    sumCnt = sumCnt - 1, 
    sumRatio = sumRatio - vs.ratio,
    sumScore = sumScore - OLD.score * vs.ratio
  where s.sid=vs.sid and vs.vid=OLD.vid;

END
]]>
		</trigger>
	</triggers>
	<table_data name="RoadSegment">
	<row>
		<field name="sid">1</field>
		<field name="segmentid">1</field>
		<field name="index_seg">1</field>
		<field name="sumScore">2.5</field>
		<field name="sumRatio">0.5</field>
		<field name="sumCnt">1</field>
		<field name="geometry">geo1</field>
	</row>
	<row>
		<field name="sid">2</field>
		<field name="segmentid">2</field>
		<field name="index_seg">2</field>
		<field name="sumScore">3.6</field>
		<field name="sumRatio">0.9</field>
		<field name="sumCnt">1</field>
		<field name="geometry">geo2</field>
	</row>
	<row>
		<field name="sid">3</field>
		<field name="segmentid">3</field>
		<field name="index_seg">3</field>
		<field name="sumScore">0</field>
		<field name="sumRatio">0</field>
		<field name="sumCnt">0</field>
		<field name="geometry">geo3</field>
	</row>
	<row>
		<field name="sid">4</field>
		<field name="segmentid">4</field>
		<field name="index_seg">4</field>
		<field name="sumScore">0</field>
		<field name="sumRatio">0</field>
		<field name="sumCnt">0</field>
		<field name="geometry">geo4</field>
	</row>
	<row>
		<field name="sid">5</field>
		<field name="segmentid">5</field>
		<field name="index_seg">5</field>
		<field name="sumScore">0</field>
		<field name="sumRatio">0</field>
		<field name="sumCnt">0</field>
		<field name="geometry">geo5</field>
	</row>
	<row>
		<field name="sid">6</field>
		<field name="segmentid">6</field>
		<field name="index_seg">6</field>
		<field name="sumScore">0</field>
		<field name="sumRatio">0</field>
		<field name="sumCnt">0</field>
		<field name="geometry">geo6</field>
	</row>
	<row>
		<field name="sid">7</field>
		<field name="segmentid">7</field>
		<field name="index_seg">7</field>
		<field name="sumScore">0</field>
		<field name="sumRatio">0</field>
		<field name="sumCnt">0</field>
		<field name="geometry">geo7</field>
	</row>
	</table_data>
	<table_data name="Users">
	<row>
		<field name="user_id">1</field>
		<field name="email">no-exp@g.com</field>
		<field name="experienceLevel" xsi:nil="true" />
		<field name="has_survey" xsi:nil="true" />
		<field name="bk_purpose" xsi:nil="true" />
		<field name="age" xsi:nil="true" />
		<field name="ethnicity" xsi:nil="true" />
		<field name="edu" xsi:nil="true" />
		<field name="marital" xsi:nil="true" />
		<field name="gender" xsi:nil="true" />
		<field name="driver" xsi:nil="true" />
		<field name="car" xsi:nil="true" />
		<field name="household_income" xsi:nil="true" />
		<field name="residence" xsi:nil="true" />
		<field name="bk_type" xsi:nil="true" />
	</row>
	<row>
		<field name="user_id">2</field>
		<field name="email">no-survey@g.com</field>
		<field name="experienceLevel">Fearless</field>
		<field name="has_survey" xsi:nil="true" />
		<field name="bk_purpose" xsi:nil="true" />
		<field name="age" xsi:nil="true" />
		<field name="ethnicity" xsi:nil="true" />
		<field name="edu" xsi:nil="true" />
		<field name="marital" xsi:nil="true" />
		<field name="gender" xsi:nil="true" />
		<field name="driver" xsi:nil="true" />
		<field name="car" xsi:nil="true" />
		<field name="household_income" xsi:nil="true" />
		<field name="residence" xsi:nil="true" />
		<field name="bk_type" xsi:nil="true" />
	</row>
	<row>
		<field name="user_id">3</field>
		<field name="email">has-survey@g.com</field>
		<field name="experienceLevel">Interested</field>
		<field name="has_survey">1</field>
		<field name="bk_purpose">1</field>
		<field name="age" xsi:nil="true" />
		<field name="ethnicity" xsi:nil="true" />
		<field name="edu" xsi:nil="true" />
		<field name="marital" xsi:nil="true" />
		<field name="gender" xsi:nil="true" />
		<field name="driver" xsi:nil="true" />
		<field name="car" xsi:nil="true" />
		<field name="household_income" xsi:nil="true" />
		<field name="residence" xsi:nil="true" />
		<field name="bk_type" xsi:nil="true" />
	</row>
	</table_data>
	<table_data name="Video">
	<row>
		<field name="vid">1</field>
		<field name="clip_name">clip1</field>
		<field name="title">title1</field>
		<field name="URL">url1</field>
	</row>
	<row>
		<field name="vid">2</field>
		<field name="clip_name">clip2</field>
		<field name="title">title2</field>
		<field name="URL">url2</field>
	</row>
	<row>
		<field name="vid">3</field>
		<field name="clip_name">clip3</field>
		<field name="title">title3</field>
		<field name="URL">url3</field>
	</row>
	<row>
		<field name="vid">4</field>
		<field name="clip_name">clip4</field>
		<field name="title">title4</field>
		<field name="URL">url4</field>
	</row>
	<row>
		<field name="vid">5</field>
		<field name="clip_name">clip5</field>
		<field name="title">title5</field>
		<field name="URL">url5</field>
	</row>
	<row>
		<field name="vid">6</field>
		<field name="clip_name">clip6</field>
		<field name="title">title6</field>
		<field name="URL">url6</field>
	</row>
	<row>
		<field name="vid">7</field>
		<field name="clip_name">clip7</field>
		<field name="title">title7</field>
		<field name="URL">url7</field>
	</row>
	</table_data>
	<table_data name="VideoRoadSeg">
	<row>
		<field name="vrsid">1</field>
		<field name="vid">1</field>
		<field name="sid">1</field>
		<field name="clip_name">clip1</field>
		<field name="index_seg">1</field>
		<field name="ratio">0.5</field>
	</row>
	<row>
		<field name="vrsid">2</field>
		<field name="vid">2</field>
		<field name="sid">2</field>
		<field name="clip_name">clip2</field>
		<field name="index_seg">2</field>
		<field name="ratio">0.9</field>
	</row>
	<row>
		<field name="vrsid">3</field>
		<field name="vid">3</field>
		<field name="sid">2</field>
		<field name="clip_name">clip3</field>
		<field name="index_seg">2</field>
		<field name="ratio">0.2</field>
	</row>
	<row>
		<field name="vrsid">4</field>
		<field name="vid">4</field>
		<field name="sid">3</field>
		<field name="clip_name">clip4</field>
		<field name="index_seg">3</field>
		<field name="ratio">0.3</field>
	</row>
	<row>
		<field name="vrsid">5</field>
		<field name="vid">4</field>
		<field name="sid">4</field>
		<field name="clip_name">clip4</field>
		<field name="index_seg">4</field>
		<field name="ratio">0.4</field>
	</row>
	<row>
		<field name="vrsid">6</field>
		<field name="vid">5</field>
		<field name="sid">4</field>
		<field name="clip_name">clip5</field>
		<field name="index_seg">4</field>
		<field name="ratio">1</field>
	</row>
	<row>
		<field name="vrsid">7</field>
		<field name="vid">6</field>
		<field name="sid">3</field>
		<field name="clip_name">clip6</field>
		<field name="index_seg">3</field>
		<field name="ratio">0.8</field>
	</row>
	<row>
		<field name="vrsid">8</field>
		<field name="vid">6</field>
		<field name="sid">4</field>
		<field name="clip_name">clip6</field>
		<field name="index_seg">4</field>
		<field name="ratio">0.6</field>
	</row>
	<row>
		<field name="vrsid">9</field>
		<field name="vid">6</field>
		<field name="sid">5</field>
		<field name="clip_name">clip6</field>
		<field name="index_seg">5</field>
		<field name="ratio">0.3</field>
	</row>
	</table_data>
	<table_data name="video2seg_temp">
	</table_data>
	<triggers name="video2seg_temp">
		<trigger Trigger="insert2VRS" sql_mode="NO_ENGINE_SUBSTITUTION" character_set_client="utf8" collation_connection="utf8_general_ci" Database_Collation="utf8_unicode_ci">
<![CDATA[
CREATE DEFINER=`cyclingsafetyumd`@`localhost` TRIGGER `insert2VRS` AFTER INSERT ON `video2seg_temp`
 FOR EACH ROW BEGIN
  INSERT INTO `VideoRoadSeg` (vid, sid, clip_name, index_seg, ratio) 
  VALUES 
  (
      (SELECT vid FROM `Video` v WHERE v.clip_name=NEW.clip_name LIMIT 1),
      (SELECT sid FROM `RoadSegment` s WHERE s.index_seg=NEW.index_seg LIMIT 1),
      NEW.clip_name, 
      NEW.index_seg, 
      New.ratio
  );
END
]]>
		</trigger>
	</triggers>
</database>
</mysqldump>
